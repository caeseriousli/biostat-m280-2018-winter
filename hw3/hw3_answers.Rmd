---
title: "Homework 3"
author: "Caesar (Zexuan) Li"
date: "2/26/2018"
output: html_document
---



## Q1 LA City Employee Payroll

The `/home/m280-data/la_payroll/LA_City_Employee_Payroll.csv` file on teaching server contains payroll information of LA City employees in years 2013-2017. It was downloaded from [LA City Controller's Office](https://controllerdata.lacity.org/Payroll/City-Employee-Payroll/pazn-qyym). Make a Shiny app to facilitate exploratory data analysis. 

1. For efficiency of the Shiny app, you should first pre-process, pare down, tidy, and save the data, e.g., as a compressed RDS file, to be used in the app.

```{r}
if (!"tidyverse" %in% rownames(installed.packages()))  
      install.packages("tidyverse", repos="http://cran.rstudio.com/")
library(tidyverse)

setwd("/home/m280-data/la_payroll/")
payroll <- read_delim("LA_City_Employee_Payroll.csv", col_names = TRUE, delim = ",")

currencies <- c(8:14, 16:24, 30:33)
payroll <- payroll %>% 
  mutate_at(funs(str_sub(.,start = 2)), .vars = vars(currencies)) %>% 
  mutate_at(funs(as.double(.)), .vars = vars(currencies)) %>%
  mutate_at(funs(as.character(.)), .vars = vars(4, 5, 25, 27))

setwd("/home/zexuan55/biostat-m280-2018-winter/hw3/hw3_shiny/data")
write_rds(payroll, "payroll.rds")
```

    Answer: read in data set with dplyr as required. Data is already tiday. Converted currancy characters to doubles for shiny app computations.

0. **Total payroll by LA City**. Visualize the total LA City payroll of each year, with breakdown into base pay, overtime pay, and other pay.

    Answer: yes I did. It's in the Shiny app's first tab.

0. **Who earned most?** Visualize the payroll information (total payment with breakdown into base pay, overtime pay, and other pay, Department, Job Title) of the top $n$ highest paid LA City employees in a specific year. User specifies $n$ (default 10) and year (default 2017).

    Answer: yes I did. It's in the Shiny app's second tab.

0. **Which departments earn most?** Visualize the mean or median payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ earning departments. User specifies $n$ (default 5), year (default 2017), and method (mean or median, default median).

    Answer: yes I did. It's in the Shiny app's third tab.

0. **Which departments cost most?** Visualize the total payroll, with breakdown into base pay, overtime pay, and other pay, of top $n$ expensive departments. User specifies $n$ (default 5) and year (default 2017).

    Answer: yes I did. It's in the Shiny app's fourth tab.

0. Visualize any other information you are interested in.

    Answer: yes I did. I added a box plot for top-earning employees by years and it's in the Shiny app's fifth tab. Users control how many top employees to be included.

0. Publish your Shiny app to <https://www.shinyapps.io> and share the link.
    
    Answer: yes I did. The link is pasted down below.
    [linked phrase]( https://caeseriousli.shinyapps.io/hw3_shiny/)

## Q2 LA City Parking War

The SQLite database `/home/m280-data/la_parking/LA_Parking_Citations.sqlite` on teaching server contains information about parking tickets in LA City. It was downloaded from [LA Open Data Portal](https://data.lacity.org/A-Well-Run-City/Parking-Citations/wjz9-h9np). Connect to the database and answer following questions using plots and summary statistics. In this exercise, you are **not** allowed to load whole data into memory. Use the _transform in database, plot in R_ strategy.

1. How many tickets are in this data set? Which time period do these tickets span? Which years have most data?

```{R}
if (!"DBI" %in% rownames(installed.packages()))  
      install.packages("DBI", repos="http://cran.rstudio.com/")
if (!"RSQLite" %in% rownames(installed.packages()))  
      install.packages("RSQLite", repos="http://cran.rstudio.com/")
if (!"lubridate" %in% rownames(installed.packages()))  
      install.packages("lubridate", repos="http://cran.rstudio.com/")

library("DBI")
library("RSQLite")
library("lubridate")
db <- dbConnect(RSQLite::SQLite(), 
                dbname = 
                "/home/m280-data/la_parking/LA_Parking_Citations_Extra.sqlite")
dbListTables(db)
tix <- dplyr::tbl(db, "Latix")
tatal <- tix %>% tally() %>% collect()

span <- tix %>%
          summary(maxd = max(Issue_Day, na.rm = T), 
                  min = min(itime, na.rm = T)) %>%
          collect()



```

0. When (which hour, weekday, month day, and month) are you most likely to get a ticket and when are you least likely to get a ticket?

0. Which car makes received most citations?

0. How many different colors of cars were ticketed? Which color attracted most tickets?

0. What are the most common ticket types?

0. How much money was collected on parking tickets in 2015 and 2016?

0. Visualize any other information you are interested in.

